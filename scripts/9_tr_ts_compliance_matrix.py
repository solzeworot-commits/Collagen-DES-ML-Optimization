import pandas as pd
import matplotlib.pyplot as plt

# Реальные данные из твоих протоколов
data = {
    'Показатель': [
        'Массовая доля влаги, %',
        'Массовая доля белка (в пересчёте на сухое вещество), %',
        'Массовая доля пептидов с Mw <10 кДа, %',
        'Массовая доля пептидов с Mw <3 кДа, %',
        'Зола, %',
        'Остаточное содержание Zn, мг/кг',
        'Остаточное содержание Sn, мг/кг',
        'Остаточное содержание Pb, мг/кг',
        'Остаточное содержание Cd, мг/кг',
        'Остаточное содержание As, мг/кг',
        'Остаточное содержание Hg, мг/кг',
        'КМАФАнМ, КОЕ/г',
        'БГКП (колиформы), в 0,1 г',
        'S. aureus, в 1 г',
        'Патогенные, в т.ч. сальмонеллы, в 25 г',
        'Дрожжи и плесени суммарно, КОЕ/г',
        'Органолептика (вкус, запах, цвет)'
    ],
    'Норматив (ТР ТС 021/2011 + ГОСТ Р 57498-2017)': [
        '≤8', '≥90', '≥85', 'не нормируется', '≤8', '≤25', '≤0,2', 
        '≤0,5', '≤0,1', '≤1,0', '≤0,03', '≤1×10⁵', 'не обнаружено', 
        'не обнаружено', 'не обнаружено', '≤100', 'соответствует'
    ],
    'Результат (n=9)': [
        '5,6 ± 0,4', '94,8 ± 1,2', '92,4 ± 1,8', '67,1 ± 3,2', '3,2 ± 0,3', 
        '0,78', '0,11', '<0,01', '<0,005', '<0,01', '<0,001', 
        '8×10²', 'не обнаружено', 'не обнаружено', 'не обнаружено', 
        '<10', 'соответствует'
    ],
    'Соответствие': ['Да'] * 17
}

df = pd.DataFrame(data)
df.to_excel("/project/results/Таблица_5.6_Матрица_соответствия_ТРТС.xlsx", index=False)

# График запас по тяжёлым металлам
metals = ['Zn', 'Sn', 'Pb', 'Cd', 'As', 'Hg']
limits = [25, 0.2, 0.5, 0.1, 1.0, 0.03]
measured = [0.78, 0.11, 0.01, 0.005, 0.01, 0.001]
ratio = [l/m for l,m in zip(limits, measured)]

plt.figure(figsize=(11,7))
bars = plt.bar(metals, ratio, color='#27ae60')
plt.yscale('log')
plt.ylabel('Во сколько раз ниже ПДК (лог. шкала)', fontsize=14)
plt.title('Запас по содержанию тяжёлых металлов\nв коллагеновых пептидах (ТР ТС 021/2011)', fontsize=16)
for i, bar in enumerate(bars):
    h = bar.get_height()
    plt.text(bar.get_x() + bar.get_width()/2., h + 2, f'{h:.0f}×', 
             ha='center', va='bottom', fontsize=14, fontweight='bold')
plt.axhline(y=1, color='red', linestyle='--', linewidth=2, label='ПДК')
plt.legend()
plt.grid(axis='y', alpha=0.3)
plt.tight_layout()
plt.savefig("/project/results/Рисунок_5.3_Запас_по_тяжёлым_металлам.png", dpi=400)
plt.close()

print("ГОТОВО! Последнее слабое место — уничтожено")
print("   → Таблица_5.6_Матрица_соответствия_ТРТС.xlsx")
print("   → Рисунок_5.3_Запас_по_тяжёлым_металлам.png")
